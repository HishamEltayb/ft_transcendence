<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Profile Test - Transcendence</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        input, select {
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .profile-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .success {
            color: #2ecc71;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
        .action-buttons {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Player Profile Test</h1>
        
        <div id="auth-status" class="card">
            <h2>Authentication Status</h2>
            <div id="auth-message">Checking authentication...</div>
            <div class="action-buttons">
                <button id="login-redirect-btn" class="hidden">Go to Login Page</button>
                <button id="logout-btn" class="hidden">Logout</button>
            </div>
        </div>

        <div id="profile-section" class="card hidden">
            <h2>Your Player Profile</h2>
            <div id="profile-data">
                <!-- Profile data will be displayed here -->
            </div>
            <button id="refresh-profile-btn">Refresh Profile</button>
        </div>

        <div id="update-profile-section" class="card hidden">
            <h2>Record Game Result</h2>
            <div>
                <label for="game-result">Game Result:</label>
                <select id="game-result">
                    <option value="win">Win</option>
                    <option value="loss">Loss</option>
                </select>
            </div>
            <button id="record-game-btn">Record Game</button>
            <p id="update-message"></p>
        </div>

        <div id="leaderboard-section" class="card hidden">
            <h2>Leaderboard</h2>
            <div id="leaderboard-data">
                <!-- Leaderboard data will be displayed here -->
            </div>
            <button id="refresh-leaderboard-btn">Refresh Leaderboard</button>
        </div>
    </div>

    <script>
        // Import existing auth functions
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Global variables
        const API_BASE_URL = '/api/users';
        const authMessage = document.getElementById('auth-message');
        const loginRedirectBtn = document.getElementById('login-redirect-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileSection = document.getElementById('profile-section');
        const profileData = document.getElementById('profile-data');
        const refreshProfileBtn = document.getElementById('refresh-profile-btn');
        const updateProfileSection = document.getElementById('update-profile-section');
        const recordGameBtn = document.getElementById('record-game-btn');
        const updateMessage = document.getElementById('update-message');
        const leaderboardSection = document.getElementById('leaderboard-section');
        const leaderboardData = document.getElementById('leaderboard-data');
        const refreshLeaderboardBtn = document.getElementById('refresh-leaderboard-btn');
        
        // Check authentication status
        function checkAuth() {
            const accessToken = getCookie('access_token');
            const refreshToken = getCookie('refresh_token');
            
            if (accessToken && refreshToken) {
                authMessage.textContent = 'Authenticated ';
                authMessage.className = 'success';
                loginRedirectBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                
                // Show profile sections
                profileSection.classList.remove('hidden');
                updateProfileSection.classList.remove('hidden');
                leaderboardSection.classList.remove('hidden');
                
                // Load initial data
                getProfile();
                getLeaderboard();
            } else {
                authMessage.textContent = 'Not authenticated. Please log in first.';
                authMessage.className = 'error';
                loginRedirectBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }
        
        // Helper function for API calls with authentication
        async function apiCall(endpoint, method = 'GET', data = null) {
            const accessToken = getCookie('access_token');
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            
            const options = {
                method,
                headers
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (response.status === 401) {
                    // Token expired - redirect to login
                    authMessage.textContent = 'Session expired. Please log in again.';
                    authMessage.className = 'error';
                    loginRedirectBtn.classList.remove('hidden');
                    return null;
                }
                
                return response;
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // Get profile data
        async function getProfile() {
            try {
                const response = await apiCall('/profile/');
                
                if (!response) return; // Auth error handled in apiCall
                
                if (response.ok) {
                    const profile = await response.json();
                    displayProfile(profile);
                } else {
                    const error = await response.json();
                    console.error('Profile error:', error);
                    profileData.innerHTML = `<p class="error">Error loading profile: ${error.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Profile fetch error:', error);
                profileData.innerHTML = '<p class="error">Error loading profile. Please try again.</p>';
            }
        }

        // Display profile data
        function displayProfile(profile) {
            let html = `
                <div class="profile-stat">
                    <strong>Username:</strong> <span>${profile.username || 'N/A'}</span>
                </div>
                <div class="profile-stat">
                    <strong>Total Games:</strong> <span>${profile.total_games}</span>
                </div>
                <div class="profile-stat">
                    <strong>Wins:</strong> <span>${profile.wins}</span>
                </div>
                <div class="profile-stat">
                    <strong>Losses:</strong> <span>${profile.losses}</span>
                </div>
                <div class="profile-stat">
                    <strong>Win Rate:</strong> <span>${profile.win_rate}%</span>
                </div>
                <div class="profile-stat">
                    <strong>Rank:</strong> <span>${profile.rank}</span>
                </div>
            `;
            
            profileData.innerHTML = html;
        }

        // Record a game result
        async function recordGame() {
            const gameResult = document.getElementById('game-result').value;
            
            try {
                const response = await apiCall('/profile/update/', 'PATCH', {
                    game_result: gameResult
                });
                
                if (!response) return; // Auth error handled in apiCall
                
                if (response.ok) {
                    const profile = await response.json();
                    updateMessage.textContent = `Game result recorded: ${gameResult}`;
                    updateMessage.className = 'success';
                    displayProfile(profile);
                    getLeaderboard(); // Refresh leaderboard after update
                } else {
                    const error = await response.json();
                    updateMessage.textContent = `Error: ${error.error || 'Failed to record game'}`;
                    updateMessage.className = 'error';
                }
            } catch (error) {
                console.error('Record game error:', error);
                updateMessage.textContent = 'Error recording game. Please try again.';
                updateMessage.className = 'error';
            }
        }

        // Get leaderboard data
        async function getLeaderboard() {
            try {
                const response = await apiCall('/leaderboard/');
                
                if (!response) return; // Auth error handled in apiCall
                
                if (response.ok) {
                    const leaderboard = await response.json();
                    displayLeaderboard(leaderboard);
                } else {
                    const error = await response.json();
                    leaderboardData.innerHTML = `<p class="error">Error loading leaderboard: ${error.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Leaderboard fetch error:', error);
                leaderboardData.innerHTML = '<p class="error">Error loading leaderboard. Please try again.</p>';
            }
        }

        // Display leaderboard data
        function displayLeaderboard(leaderboard) {
            let html = '';
            
            if (Array.isArray(leaderboard)) {
                // Display simple leaderboard
                leaderboard.forEach((player, index) => {
                    html += `
                        <div class="leaderboard-item">
                            <span>#${index + 1} ${player.username}</span>
                            <span>Rank: ${player.rank} | Win Rate: ${player.win_rate}%</span>
                        </div>
                    `;
                });
            } else if (leaderboard.leaderboard && leaderboard.user_stats) {
                // Display enhanced leaderboard with user stats
                html += '<h3>Top Players</h3>';
                leaderboard.leaderboard.forEach((player, index) => {
                    html += `
                        <div class="leaderboard-item">
                            <span>#${index + 1} ${player.username}</span>
                            <span>Rank: ${player.rank} | Win Rate: ${player.win_rate}%</span>
                        </div>
                    `;
                });
                
                html += `
                    <h3>Your Ranking</h3>
                    <div class="leaderboard-item">
                        <span>#${leaderboard.user_stats.position} ${leaderboard.user_stats.profile.username}</span>
                        <span>Rank: ${leaderboard.user_stats.profile.rank} | Win Rate: ${leaderboard.user_stats.profile.win_rate}%</span>
                    </div>
                `;
            } else {
                html = '<p>No players found</p>';
            }
            
            leaderboardData.innerHTML = html;
        }
        
        // Event listeners
        loginRedirectBtn.addEventListener('click', function() {
            window.location.href = '/';
        });
        
        logoutBtn.addEventListener('click', function() {
            // Clear cookies and redirect to login
            document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
            document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
            localStorage.removeItem('user');
            window.location.href = '/';
        });
        
        refreshProfileBtn.addEventListener('click', getProfile);
        recordGameBtn.addEventListener('click', recordGame);
        refreshLeaderboardBtn.addEventListener('click', getLeaderboard);

        // Initialize the page
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>